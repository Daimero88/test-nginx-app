name: Deploy App

on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
          sed -i "s/Version: .*/Version: ${{ env.VERSION }}/" index.html

    - name: Login to Yandex Container Registry
      run: |
        echo "${{ secrets.YC_SECRET_KEY }}" | docker login \
          --username ${{ secrets.YC_ACCESS_KEY }} \
          --password-stdin \
          cr.yandex.ru

      - name: Build and push Docker image
        run: |
          docker build -t cr.yandex/${{ secrets.YC_REGISTRY_ID }}/test-nginx-app:${{ env.VERSION }} .
          echo "${{ secrets.YC_SA_KEY }}" | docker login --username json_key --password-stdin cr.yandex.ru
          docker push cr.yandex/${{ secrets.YC_REGISTRY_ID }}/test-nginx-app:${{ env.VERSION }}

    - name: Configure kubectl
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config
        chmod 600 ~/.kube/config

    - name: Deploy to Cluster
      run: |
        kubectl set image deployment/test-nginx \
          test-nginx=cr.yandex/${{ secrets.YC_REGISTRY_ID }}/test-nginx-app:${{ env.VERSION }} -n ssilchin-nginx
